---
title: "Quantitative Text Analysis in R"
subtitle: "A gentle hands-on introduction"
output: 
  xaringan::moon_reader:
    css:
      - default
      - css/styles.css
      - css/fonts.css
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%<br>"
      ratio: "16:9"
    includes:
      after_body: "collapseoutput.js"
---


layout: true

<style>
.onehundredtwenty {
  font-size: 120%;
   }

<style>
.ninety {
  font-size: 90%;
   }

.eightyfive {
  font-size: 85%;
   }
   
.eighty {
  font-size: 80%;
   }
   
.seventyfive {
  font-size: 75%;
   }
   
.seventy {
  font-size: 70%;
   }
   
.fifty {
  font-size: 50%;
   }
   
.forty {
  font-size: 40%;
   }
</style>


```{r meta, echo=FALSE, warning=F, message=F}


library(metathis)
meta() %>%
  meta_general(
    description = "Quantitative Text Analysis in R",
    generator = "xaringan and remark.js"
  ) %>%
  meta_name("github-repo" = "favstats/xxx") %>%
  meta_social(
    title = "Quantitative Text Analysis in R",
    url = "https://www.favstats.eu",
    og_type = "website",
    og_author = "Fabio Votta",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@favstats"
  )
```



```{r setup, include=FALSE}
# dateWritten <- format(as.Date('2020-05-04'), format="%B %d %Y")
workshop_day <- format(as.Date("2022-06-29"), format="%B %d %Y")
pacman::p_load(tidyverse, fontawesome, tidyverse, knitr, xaringanthemer)

options(
    htmltools.dir.version = FALSE,
    knitr.table.format = "html",
    knitr.kable.NA = ""
)
knitr::opts_chunk$set(
    warning = FALSE,
    message = FALSE,
    fig.path = "figs/",
    fig.width = 7.252,
    fig.height = 4,
    comment = "#>",
    fig.retina = 3 # Better figure resolution
)



# Enables the ability to show all slides in a tile overview by pressing "o"
xaringanExtra::use_tile_view()
xaringanExtra::use_panelset()
xaringanExtra::use_clipboard()
# xaringanExtra::use_share_again()
# xaringanExtra::style_share_again(share_buttons = "all")
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,
  mute_unhighlighted_code = FALSE
)
# xaringanExtra::use_webcam()


knitr::opts_chunk$set(warning = F, message = F) # Whether to display errors
```



---
name: title-slide
class: title-slide, center, middle


<div class="my-logo-right"></div> 

<br>

# .font150[.fancy[`r rmarkdown::metadata$title`]] 

### .font120[.fancy[`r rmarkdown::metadata$subtitle`]]

*Spring Camp University of Warwick*

Instructor: Fabio Votta

[`r fa(name = "twitter", fill = "white")` @favstats](http://twitter.com/favstats)<br>
[`r fa(name = "github", fill = "white")` @favstats](http://github.com/favstats)<br>
[`r fa(name = "globe", fill = "white")` favstats.eu](https://www.favstats.eu)


29th June 2022 (Day 2)

.fifty[Link to slides: [favstats.github.io/WarwickSpringCamp_QTA/slides/day2/](https://favstats.github.io/WarwickSpringCamp_QTA/slides/day2/)]

---

class: center, middle

# Part-of-speech tagging

<center>

<img src="https://i2.wp.com/www.bnosac.be/images/bnosac/blog/depenceny-parsing-example3.png?w=584">

  
</center>

---


## Part-of-speech tagging

> Part-of-speech tagging is the process of assigning a syntactic tag to each word in a sentence. 

For example, in the sentence: 

`"The dog chased the cat."`

1. "dog" and "cat" would be assigned the tag "noun"

2. "chased" would be assigned the tag "verb." 

The most common parts of speech are nouns, verbs, adjectives, adverbs, and pronouns, but there are many more!

---


## NLP with `udpipe`


> "`udpipe` provides quick and simple annnotations giving rich output: tokenization, part-of-speech-tagging, lemmatization and dependency parsing with multi-language support. From raw text to parsed output for more than 50 languages."

```{r}
library(udpipe)
```


---

### NLP with `udpipe`

.font70[
*The* following table contains the so-called **universal part-of-speech tags** (upos). 

]

.font40[

| Universal POS tags | Meaning                   | Definition                                                                                                                                                                                                                      | Example                                                          |
|--------------------|---------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
| ADJ                | adjective                 | Adjectives are words that typically modify nouns and specify their properties or attributes:                                                                                                                                    | The car is **green**.                                            |
| ADP                | adposition                | In many languages, adpositions can take the form of fixed multiword expressions,                                                                                                                                                | **in** spite **of**, because **of**, thanks **to**               |
| ADV                | adverb                    | Adverbs are words that typically modify verbs for such categories as time, place, direction or manner.                                                                                                                          | He ate **slowly**.                                               |
| AUX                | auxiliary                 | An auxiliary is a function word that accompanies the lexical verb of a verb phrase and expresses<br>grammatical distinctions not carried by the lexical verb, such as person, number, tense, mood, aspect,<br>voice or evidentiality. | Tense auxiliaries: **has** (done), **is** (doing), **will** (do) |
| CCONJ              | coordinating conjunction  | A coordinating conjunction is a word that links words or larger constituents without syntactically<br>subordinating one to the other and expresses a semantic relationship between them.                                           | **and**, **or**, **but**                                         |
| DET                | determiner                | Determiners are words that modify nouns or noun phrases and express the reference of the noun phrase in context.                                                                                                                | **the**, **this**, **that**, **which**                           |
| INTJ               | interjection              | An interjection is a word that is used most often as an exclamation or part of an exclamation.                                                                                                                                  | **psst**, **ouch**                                               |
| NOUN               | noun                      | Nouns are a part of speech typically denoting a person, place, thing, animal or idea.                                                                                                                                           | The **cat** is in the **hat**.                                   |
| NUM                | numeral                   | A numeral is a word, functioning most typically as a determiner, adjective or pronoun, that expresses<br>a number and a relation to the number, such as quantity, sequence, frequency or fraction.                                 | **0**, **1**, **2**, **one**, **two**, **three**                 |
| PART               | particle                  | Particles are function words that must be associated with another word or phrase to impart meaning<br>and that do not satisfy definitions of other universal parts of speech                                                       | Possessive marker: [en] â€˜s                                       |
| PRON               | pronoun                   | Pronouns are words that substitute for nouns or noun phrases, whose meaning is recoverable<br>from the linguistic or extralinguistic context.                                                                                      | personal pronouns: I, you, he, she, it, we, they                 |
| PROPN              | proper noun               | A proper noun is a noun (or nominal content word) that is the name (or part of the name)<br>of a specific individual, place, or object.                                                                                            | **London**, **NATO**, **Mary Sue**                               |
| PUNCT              | punctuation               | Punctuation marks are non-alphabetical characters and character groups used in many languages<br>to delimit linguistic units in printed text.                                                                                      | **,**, **.**, **(**, **:**                                       |
| VERB               | verb                      | A verb is a member of the syntactic class of words that typically signal events and actions                                                                                                                                     | He **runs**.                                                     |



]

---

### One function to rule them all: `udpipe()`

`udpipe()` is the main work horse of the `udpipe` package. With it you can perform

+ tokenization
+ lemmatization
+ part-of-speech tagging
+ dependency parsing

**all in one!**

>  On dependency parsing:  dependency parsing is a type of syntactic parsing that identifies the dependencies between words in a sentence. Dependency parsers typically use a set of rules to find these dependencies, and these rules can vary depending on the language being parsed.


---

#### Trump tweet example


Let's apply `udpipe()` on the "nuclear" Trump tweet from yesterday and see what it can do for us!

```{r}
## read in Trump tweets
trump_tweets <- readr::read_csv("https://raw.githubusercontent.com/favstats/WarwickSpringCamp_QTA/main/docs/slides/day1/data/trump_tweets.csv")


## nuclear tweet
trump_tweet <- trump_tweets[trump_tweets$id == 1165918301932916736,]

trump_tweet$text
```


---

#### Trump tweet example

.pull-left[

`udpipe()` expects a data.frame with two variables:

1. `doc_id`, a unique identifier for your document
2. `text`, the text you are trying to parse



```{r, eval = F}
trump_tweet_ud <- trump_tweet %>%
  mutate(doc_id = id)

pos_tags_trump <- udpipe(trump_tweet_ud, "english")

pos_tags_trump %>%
  select(token, upos, lemma) %>% kable()
```

]

.pull-right[



```{r, echo = F}
trump_tweet_ud <- trump_tweet %>%
  mutate(doc_id = id)

pos_tags_trump <- udpipe(trump_tweet_ud, "english")

pos_tags_trump %>%
  select(token, upos, lemma, dep_rel) %>% 
  slice(1:22) %>%
  kable() %>% kableExtra::kable_styling(font_size = 10) 
```


]


---

### Visualizing the nice tidy data frame that `udpipe()` puts out

.font50[
We can visualize all the output from `udpipe()` using the function (taken from [here](https://www.r-bloggers.com/2019/07/dependency-parsing-with-udpipe/#:~:text=Dependency%20parsing%20is%20an%20NLP,you%20further%20details%20about%20it.)).
]



![](https://pbs.twimg.com/media/FWAb-SFX0AAzW4n?format=jpg&name=large)

---

### Keyword extraction

.font80[


Now we have tags for our text. Brilliant. What can we do with this? 

Similar as before, we are interested in what's going on in our text. 

Part-of-speech tagging can enable us to find more meaningful keywords that tell us something about the texts we are investigating.

`udpipe()` offers various methods for keyword extractions:


1.   Find keywords by doing **parts of speech tagging in order to identify nouns**
2. Find keywords based on **collocations and co-occurrences**
3. Find keywords based on algorithms
  * **RAKE** (rapid automatic keyword extraction)
4. Find keywords by looking for **phrases** (e.g. noun phrases)
5. Find keywords based on results of **dependency parsing** (getting the subject of the text)


]


---

#### Most frequent nouns/verbs etc.

Let's now run part-of-speech tagging to find the most common nouns and verbs that Trump uses.

```{r, eval = F}
# This takes a couple of minutes

trump_tweets_uds <- trump_tweets %>%
  filter(date_year %in% 2016:2021) %>%
  mutate(doc_id = id)  %>%
  mutate(doc_id = as.character(doc_id))

pos_tags_trump_all <- udpipe(trump_tweets_uds, "english")  %>%
  left_join(trump_tweet_ud)
```

```{r, echo = F}
pos_tags_trump_all <- readRDS(url("https://raw.githubusercontent.com/favstats/WarwickSpringCamp_QTA/main/docs/slides/day2/data/pos_tags_trump_all.rds"))

```


---

#### Most frequent nouns


```{r}
pos_tags_trump_all %>%
  filter(upos == "NOUN") %>%
  count(token, sort = T) %>%
  head(10)  %>% 
  mutate(word_n = paste0(token, ": ", n)) %>% 
  pull(word_n)
```


---

#### Most frequent verbs



```{r}
pos_tags_trump_all %>%
  filter(upos == "VERB") %>%
  count(token, sort = T) %>%
  head(10)  %>% 
  mutate(word_n = paste0(token, ": ", n)) %>% 
  pull(word_n)
```

---

#### RAKE (rapid automatic keyword extraction)

> RAKE is a basic algorithm which tries to identify keywords in text. Keywords are defined as a sequence of words following one another. 

Frequency of occurence plays a role as well, as well as frequency of co-occurences with other words. Word combinatiosn with higher values are considered to be more frequent and unique.

If you want to know more about RAKE [see here](https://www.analyticsvidhya.com/blog/2021/10/rapid-keyword-extraction-rake-algorithm-in-natural-language-processing/).


---

#### RAKE (rapid automatic keyword extraction)

.panelset[
.panel[.panel-name[Extract RAKE]


```{r}
## Using RAKE
rake_keys <- keywords_rake(
  x = pos_tags_trump_all %>% mutate(lemma = stringr::str_to_lower(lemma)), 
  term = "lemma", group = "doc_id", 
  relevant = pos_tags_trump_all$upos %in% c("NOUN", "VERB", "ADJ")
  )
                       
```

]


.panel[.panel-name[Visualization code]

```{r, eval = F}

library(ggplot2)


#stats
rake_keys %>% 
  filter(freq > 5) %>%
  arrange(-rake) %>%
  mutate(keyword = forcats::fct_reorder(keyword, rake)) %>%
  slice(1:20) %>%
  ggplot(aes(keyword, rake)) +
  geom_col() +
  coord_flip() +
  theme_minimal()
```

]


.panel[.panel-name[Visualization]

```{r, echo = F}
#stats
rake_keys %>% 
  filter(freq > 5) %>%
  arrange(-rake) %>%
  mutate(keyword = forcats::fct_reorder(keyword, rake)) %>%
  slice(1:20) %>%
  ggplot(aes(keyword, rake)) +
  geom_col() +
  coord_flip() 
```

]

]

---

#### (Simple) Noun Phrases



Next option is to extract (simple) noun phrases. What are they?

Noun phrases are groups of words that function like nouns.

Some examples:

**All the children** were eating.

She bought herself **a beautiful dark dress**.

Dad baked **a tasty chocolate cake**.



---

#### (Simple) Noun Phrases

.font80[

How does this work? Parts of Speech tags are recoded to one of the following one-letters: 

> A: adjective, C: coordinating conjuction, D: determiner, M: modifier of verb, N: noun or proper noun, P: pre/postposition. 

Next you can define a regular expression to indicate a sequence of parts of speech tags which you want to extract from the text.

As regex we can express a (simple) noun phrase as this:

> `(A|N)*N(P+D*(A|N)*N)*`

For more info on noun phrases [see here](https://universaldependencies.org/workgroups/newdoc/simple_noun_phrases.html).

]


---


#### (Simple) Noun Phrases

```{r}
## Simple noun phrases (a adjective+noun, pre/postposition, optional determiner and another adjective+noun)
pos_tags_trump_all$phrase_tag <- as_phrasemachine(pos_tags_trump_all$upos, type = "upos")

keyw_nounphrases <- keywords_phrases(pos_tags_trump_all$phrase_tag, term = pos_tags_trump_all$token, 
                                     pattern = "(A|N)*N(P+D*(A|N)*N)*", is_regex = TRUE, 
                                     detailed = T)


```


---


#### Most common (simple) noun phrases

```{r}
keyw_nounphrases %>%
  filter(ngram >= 3) %>%
  count(keyword, sort = T) %>%
  head(20)  %>% 
  mutate(keyword_n = paste0(keyword, ": ", n)) %>% 
  pull(keyword_n)
```

---

#### Dependency Parsing

For this exercise we are going to take the words which have as dependency relation "*nsubj*" indicating the nominal subject and we are adding to that the adjective which is changing the nominal subject.


```{r}
stats <- merge(pos_tags_trump_all, pos_tags_trump_all, 
           by.x = c("doc_id", "paragraph_id", "sentence_id", "head_token_id"),
           by.y = c("doc_id", "paragraph_id", "sentence_id", "token_id"),
           all.x = TRUE, all.y = FALSE, 
           suffixes = c("", "_parent"), sort = FALSE) 

stats <- subset(stats, dep_rel %in% c("nsubj") & upos %in% c("NOUN", "PROPN") & upos_parent %in% c("ADJ"))

stats$term <- paste(stats$lemma_parent, stats$lemma, sep = " ")


```

---


#### Dependency Parsing

```{r}
stats %>%
  count(term, sort = T) %>%
  head(20)   %>% 
  mutate(term_n = paste0(term, ": ", n)) %>% 
  pull(term_n)
```

---

## Topic Models

---

## Supervised machine learning

